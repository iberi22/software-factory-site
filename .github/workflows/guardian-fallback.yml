name: üõ°Ô∏è Guardian Fallback (Public Runner)

on:
  # Run every hour as a fallback in case Cloudflare is down
  schedule:
    - cron: '0 * * * *'
  # Allow manual trigger from the Private Repo (via API)
  repository_dispatch:
    types: [guardian-fallback]
  workflow_dispatch:

jobs:
  guardian-fallback:
    runs-on: ubuntu-latest
    steps:
      - name: üîç Check Private Repo PRs
        uses: actions/github-script@v7
        env:
          # This token must have access to the PRIVATE repo (software-factory)
          # Add it to software-factory-site secrets as PRIVATE_REPO_PAT
          GH_TOKEN: ${{ secrets.PRIVATE_REPO_PAT }}
        with:
          github-token: ${{ secrets.PRIVATE_REPO_PAT }}
          script: |
            const owner = 'iberi22';
            const repo = 'software-factory';

            console.log(`üîç Checking ${owner}/${repo} for mergeable PRs...`);

            // 1. List Open PRs
            const prs = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              per_page: 100
            });

            console.log(`Found ${prs.data.length} open PRs`);

            for (const pr of prs.data) {
              // 2. Check Reviews
              const reviews = await github.rest.pulls.listReviews({
                owner,
                repo,
                pull_number: pr.number
              });

              const approved = reviews.data.some(r => r.state === 'APPROVED');

              // 3. Check Status Checks
              const checks = await github.rest.checks.listForRef({
                owner,
                repo,
                ref: pr.head.sha
              });

              const allChecksPassed = checks.data.check_runs.every(c => c.conclusion === 'success' || c.conclusion === 'skipped');

              // 4. Check Labels (Blockers)
              const labels = pr.labels.map(l => l.name);
              const blocked = labels.includes('high-stakes') || labels.includes('needs-human');

              if (approved && allChecksPassed && !blocked) {
                console.log(`‚úÖ PR #${pr.number} is eligible for auto-merge. Merging...`);

                try {
                  await github.rest.pulls.merge({
                    owner,
                    repo,
                    pull_number: pr.number,
                    merge_method: 'squash'
                  });
                  console.log(`üöÄ PR #${pr.number} merged successfully via Fallback!`);
                } catch (error) {
                  console.error(`‚ùå Failed to merge PR #${pr.number}:`, error.message);
                }
              } else {
                console.log(`Skipping PR #${pr.number}: Approved=${approved}, Checks=${allChecksPassed}, Blocked=${blocked}`);
              }
            }
