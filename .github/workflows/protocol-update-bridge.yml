name: ðŸ”„ Protocol Update Checker (Public Bridge)

on:
  schedule:
    # Check every Monday at 9am UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  check-and-notify:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ” Check Protocol Versions
        id: check
        run: |
          # Fetch remote version from Git-Core-Protocol
          REMOTE=$(curl -s https://raw.githubusercontent.com/iberi22/Git-Core-Protocol/main/VERSION)
          echo "remote=$REMOTE" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Latest protocol version: $REMOTE"

          # Fetch current version from private repo
          LOCAL=$(curl -s \
            -H "Authorization: token ${{ secrets.PRIVATE_REPO_PAT }}" \
            -H "Accept: application/vnd.github.v3.raw" \
            https://api.github.com/repos/iberi22/software-factory/contents/.git-core-protocol-version)

          echo "local=$LOCAL" >> $GITHUB_OUTPUT
          echo "ðŸ  Current version in software-factory: $LOCAL"

          if [ "$LOCAL" != "$REMOTE" ]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Update available: $LOCAL â†’ $REMOTE"
          else
            echo "update_available=false" >> $GITHUB_OUTPUT
            echo "âœ… Already up to date"
          fi

      - name: ðŸ“¢ Create Issue in Private Repo
        if: steps.check.outputs.update_available == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PRIVATE_REPO_PAT }}
          script: |
            const owner = 'iberi22';
            const repo = 'software-factory';
            const local = '${{ steps.check.outputs.local }}';
            const remote = '${{ steps.check.outputs.remote }}';

            // Check if issue already exists
            const { data: existingIssues } = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: 'protocol-update',
              per_page: 1
            });

            if (existingIssues.length > 0) {
              console.log('Issue already exists, skipping creation');
              return;
            }

            // Create new issue
            await github.rest.issues.create({
              owner,
              repo,
              title: `ðŸ”„ Protocol Update Available: ${local} â†’ ${remote}`,
              body: `## Protocol Update Available

            **Current Version:** \`${local}\`
            **Latest Version:** \`${remote}\`

            A new version of Git-Core Protocol is available.

            ### Update Command
            \`\`\`bash
            # Review changes first
            curl -s https://raw.githubusercontent.com/iberi22/Git-Core-Protocol/main/CHANGELOG.md

            # Then update
            ./scripts/update-protocol.sh
            # or
            npx wrangler deploy --config wrangler.toml
            \`\`\`

            ---
            *Auto-generated by Public Runner Bridge*`,
              labels: ['protocol-update', 'maintenance']
            });

            console.log('âœ… Issue created successfully');
